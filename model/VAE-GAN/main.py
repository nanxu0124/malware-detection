import sys
import os
current_dir = os.path.dirname(__file__)
project_dir = os.path.abspath(os.path.join(current_dir, '../..'))
sys.path.append(project_dir)

import re
import torch
import pickle

import random
import numpy as np

import configparser
import pandas as pd
import torch.nn as nn

from models import *
from train import *
from utils import utils
from data.ali_data import ali_dataset

from torch.optim import Adam
from torch.utils.data import Dataset, DataLoader


# 创建一个配置解析器对象
config = configparser.ConfigParser()
# 读取INI文件
config.read('./config/config.ini')

# 设置embedding随机种子
# seed = 42
# torch.manual_seed(seed)
# torch.cuda.manual_seed(seed)
# random.seed(seed)
# np.random.seed(seed)

if __name__ == '__main__':

    # 数据集构建
    train_dataset = ali_dataset.ALiDataset(train=True)
    train_dataloader = DataLoader(train_dataset, batch_size=int(config['VAE-GAN']['batch_size']), shuffle=True, collate_fn=ali_dataset.collate_fn_vocab, drop_last=True)

    test_dataset = ali_dataset.ALiDataset(train=False)
    test_dataloader = DataLoader(test_dataset, batch_size=int(config['VAE-GAN']['batch_size']), shuffle=True, collate_fn=ali_dataset.collate_fn_vocab, drop_last=True)


    # 模型定义
    encoder = Encoder().to(utils.device())
    decoder = Decoder().to(utils.device())
    # discriminator = Discriminator().to(utils.device())
    cla = Classifier().to(utils.device())


    # 创建保存模型文件夹
    folder_path = utils.create_folder('./model/VAE-GAN/model_file')

    # 训练模型
    # AutoEncoder_Losses = train_autoencoder(encoder, decoder, train_dataloader, folder_path)
    # encoder.load_state_dict(torch.load('./model/VAE-GAN/model_file/2023-10-14_21-39-13_0.4847/Encoder_model_state_dict.pkl'))
    # Cla_losser = train_ClaModel(encoder,cla,train_dataloader,folder_path)

    # 消融实验
    # EncoderClaLosses = EncoderClaTrain(encoder,cla,train_dataloader,folder_path)

    AutoEncoderClaTrainLoss, Cla_Losses = AutoEncoderClaTrain(encoder, decoder, cla, train_dataloader, folder_path)

    # 保存本次训练的loss到文件
    # utils.save_loss(folder_path, AutoEncoder_Losses, "AutoEncoder_Losses")
    # utils.save_loss(folder_path, Cla_losser, "Cla_losser")
    # utils.save_loss(folder_path, EncoderClaLosses, "EncoderClaLosses")
    utils.save_loss(folder_path, AutoEncoderClaTrainLoss, "AutoEncoderClaTrainLoss")
    utils.save_loss(folder_path, Cla_Losses, "Cla_Losses")



    # # 测试结果
    recall, f1, accuracy = test(encoder, cla, test_dataloader)

    # 保存测试结果
    utils.model_info_save(folder_path=folder_path,  recall=recall, f1=f1, accuracy=accuracy, configfile=config)

    # 画图
    # utils.plt_curve(AutoEncoder_Losses, int(config['VAE-GAN']['epoch_autoencoder']))
    # utils.plt_curve(EncoderClaLosses, int(config['VAE-GAN']['epoch_cla']))
    utils.plt_curve(AutoEncoderClaTrainLoss, int(config['VAE-GAN']['epoch_cla']))
